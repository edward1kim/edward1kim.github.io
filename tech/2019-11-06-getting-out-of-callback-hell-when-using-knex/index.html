<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><style data-href="/styles.e863c3bf88e5ceda6696.css" id="gatsby-global-css">html{font-size:calc(12.66667px + .41667vw)}body{margin:0 auto;font-family:Proxima Nova,Helvetica Neue,Helvetica,Arial,sans-serif}img{display:block;max-width:700px;margin-left:auto;margin-right:auto;padding:10px 0}header{background:#000;min-height:40px;max-width:450px;margin:0 auto;border-radius:0 0 15px 15px}footer{padding:1em 0;margin:2em 0;min-height:100px;border-top:1px solid #ccc;text-align:center}.navbar{display:flex;flex:1 1;margin:0 auto;padding:0;justify-content:center;font-size:14px}.navbarLink:hover{opacity:1}.navbarLink{list-style-type:none;padding:.7rem;opacity:.75}.navbarLink a{color:#fff;text-decoration:none}.caption{text-align:right}.layoutMain{max-width:800px;margin:0 auto;justify-content:center}.date{color:rgba(54,54,58,.8);margin-top:5px}.postListsTitle{margin-bottom:5px}.postListsTitle a{color:#000;text-decoration:none}.postText{line-height:150%}.postTitle{margin-bottom:5px}code[class*=language-],pre[class*=language-]{color:#000;background:none;text-shadow:0 1px #fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-ms-hyphens:none;hyphens:none}code[class*=language-]::selection,code[class*=language-] ::selection,pre[class*=language-]::selection,pre[class*=language-] ::selection{text-shadow:none;background:#b3d4fc}@media print{code[class*=language-],pre[class*=language-]{text-shadow:none}}pre[class*=language-]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*=language-],pre[class*=language-]{background:#f5f2f0}:not(pre)>code[class*=language-]{padding:.1em;border-radius:.3em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#708090}.token.punctuation{color:#999}.token.namespace{opacity:.7}.token.boolean,.token.constant,.token.deleted,.token.number,.token.property,.token.symbol,.token.tag{color:#905}.token.attr-name,.token.builtin,.token.char,.token.inserted,.token.selector,.token.string{color:#690}.language-css .token.string,.style .token.string,.token.entity,.token.operator,.token.url{color:#9a6e3a;background:hsla(0,0%,100%,.5)}.token.atrule,.token.attr-value,.token.keyword{color:#07a}.token.class-name,.token.function{color:#dd4a68}.token.important,.token.regex,.token.variable{color:#e90}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}</style><meta name="generator" content="Gatsby 2.31.0"/><title data-react-helmet="true">Edward Kim</title><link data-react-helmet="true" rel="canonical" href="https://www.eggwardkim.com"/><meta data-react-helmet="true" charSet="utf-8"/><link as="script" rel="preload" href="/webpack-runtime-2eff9db88669ab49d242.js"/><link as="script" rel="preload" href="/styles-bc72ca78f9bad9fb1f45.js"/><link as="script" rel="preload" href="/framework-83e11af5cf111be5ad89.js"/><link as="script" rel="preload" href="/app-dd393d78d8098383f3b5.js"/><link as="script" rel="preload" href="/commons-9aaf2ec6d857a38f30e0.js"/><link as="script" rel="preload" href="/component---src-templates-post-js-27775870f30f322c2407.js"/><link as="fetch" rel="preload" href="/page-data/tech/2019-11-06-getting-out-of-callback-hell-when-using-knex/page-data.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/sq/d/1947816842.json" crossorigin="anonymous"/><link as="fetch" rel="preload" href="/page-data/app-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><header><div><div><nav><ul class="navbar"><li class="navbarLink"><a href="/">HOME</a></li><li class="navbarLink"><a href="/about/">ABOUT</a></li><li class="navbarLink"><a href="/food/">FOOD</a></li><li class="navbarLink"><a href="/life/">LIFE</a></li><li class="navbarLink"><a href="/tech/">TECH</a></li><li class="navbarLink"><a href="/tidbits/">TIDBITS</a></li></ul></nav></div></div></header><div class="layoutMain"><main><h2 class="postTitle">Getting Out of Callback Hell When Using Knex</h2><h5 class="date">November 06, 2019</h5><div class="postText"><p>It's been several months since I updated anything on that site. I got a bit occupied with my job and enjoying life. In that time, I got a pretty solid handle of Javascript, HTML, and CSS through the bootcamp at work. I recently worked on a project that utilized all of this and a SQL query builder library in Node called <a href="https://www.npmjs.com/package/knex" target="_blank" rel="nofollow noopener noreferrer">knex.js</a>. </p>
<p>For my project, I wanted to make all these queries, have them done in a specific order, and then render data onto a template I built out. However, for some reason, the template would show on my browser with none or just some of the data, but never all until I refreshed the page again. This is because Javascript allows asynchronous processes, and Knex queries are asynchoronous. They have to be because you don't know how long it'll take to retrieve your specified data, and your code should keep continuing forward without waiting for it, if it doesn't have to. </p>
<p>Asynchronous processes return a <code>Promise</code> type, which just signals to the browser that this is asynchronous, it's doing its own thing, and will resolve eventually. A solid use case for this is when you want to grab data from multiple independent tables. You can save time by querying them all at essentially the same point and then waiting for the Promises to all resolve (using <code>Promise.all()</code>). Your runtime will just be the longest query. </p>
<p>However, what if you want to do queries in a certain order? You can use a <code>.then()</code> statement that executes once a Promise is finished and do another knex query within that <code>.then()</code> statement. And being honest here, I'm not sure if that really does it in order, because I've had mixed results on my queries. </p>
<p>With a couple queries, it's not bad. But when you start doing three or more queries, it starts to look ugly and you get into this world called callback hell. Here's an example below:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">let</span> <span class="token function-variable function">queries</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token function">knex</span><span class="token punctuation">(</span>table1<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result1</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
            <span class="token function">knex</span><span class="token punctuation">(</span>table2<span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> result1<span class="token punctuation">.</span>t2_id <span class="token punctuation">}</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result2</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                    <span class="token function">knex</span><span class="token punctuation">(</span>table3<span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> result2<span class="token punctuation">.</span>t3_id <span class="token punctuation">}</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">result3</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
                            <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
                        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>Yeah, that got ugly really quickly. A quick and very reliable fix to clean up this code is using <code>async-await</code>. By putting <code>async</code> in front of a function, you're signaling that this function is going to be asynchronous. The <code>await</code> is put in front of other functions within that function to tell the compiler to wait and don't go any farther in the code until this is resolved. We can easily clean up the above code to this:</p>
<div class="gatsby-highlight" data-language="javascript"><pre style="counter-reset: linenumber NaN" class="language-javascript line-numbers"><code class="language-javascript"><span class="token keyword">let</span> <span class="token function-variable function">queries</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> result1 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">knex</span><span class="token punctuation">(</span>table1<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> <span class="token number">4</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result2 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">knex</span><span class="token punctuation">(</span>table2<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> result1<span class="token punctuation">.</span>t2_id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> result3 <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">knex</span><span class="token punctuation">(</span>table3<span class="token punctuation">.</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token punctuation">{</span> id<span class="token operator">:</span> result2<span class="token punctuation">.</span>t3_id <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">.</span> <span class="token punctuation">.</span> <span class="token punctuation">.</span>
<span class="token punctuation">}</span></code><span aria-hidden="true" class="line-numbers-rows" style="white-space: normal; width: auto; left: 0;"><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>
<p>That's a lot better.</p>
<p>Okay, that's about it. I just wanted to tell whoever reads this that things can be better. Keep it up, whoever you are!</p></div></main></div><footer><h5 classNae="footerDetails">© <!-- -->2021<!-- --> Edward Kim, Built with<!-- --> <a href="https://www.gatsbyjs.com">Gatsby</a></h5></footer></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/tech/2019-11-06-getting-out-of-callback-hell-when-using-knex/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-9e9c796164da25fa8bfb.js"],"app":["/app-dd393d78d8098383f3b5.js"],"component---src-pages-about-js":["/component---src-pages-about-js-a72ca751804dd8454d72.js"],"component---src-pages-index-js":["/component---src-pages-index-js-00278b246d4dbb8790bf.js"],"component---src-templates-post-js":["/component---src-templates-post-js-27775870f30f322c2407.js"],"component---src-templates-post-lists-js":["/component---src-templates-post-lists-js-4c6b8e45318a5e5c872c.js"]};/*]]>*/</script><script src="/polyfill-9e9c796164da25fa8bfb.js" nomodule=""></script><script src="/component---src-templates-post-js-27775870f30f322c2407.js" async=""></script><script src="/commons-9aaf2ec6d857a38f30e0.js" async=""></script><script src="/app-dd393d78d8098383f3b5.js" async=""></script><script src="/framework-83e11af5cf111be5ad89.js" async=""></script><script src="/styles-bc72ca78f9bad9fb1f45.js" async=""></script><script src="/webpack-runtime-2eff9db88669ab49d242.js" async=""></script></body></html>